<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Lining</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 기존 스타일 */

        .menu-item,
        .selected-item {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-direction: column;
            transition: transform 0.2s;
        }

        .menu-item img {
            width: 250px;
            height: 250px;
        }

        .menu-item:hover {
            transform: scale(1.05);
        }

        .selected-item span {
            margin: 0 5px;
        }

        .actions button {
            margin: 5px;
        }

        .card-body {
            text-align: center;
        }

        .fly-to-cart {
            position: absolute;
            z-index: 1000;
            transition: transform 1s ease-in-out;
        }

        #selectedItemsList {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .selected-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-direction: row;
            width: 600px;
            margin: 5px 0;
        }

        .selected-item img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Silver Lining</h2>
    <h2>음성 입력하기</h2>
    <form id="speechForm">
        {% csrf_token %}
        <button type="button" id="startButton">음성 입력 시작</button>
    </form>
    <p id="transcription"></p>

    <div class="button d-flex flex-wrap justify-content-center" id="menuContainer">
        {% for menu in menus %}
            <div class="menu-item card" onclick="addItem('{{ menu.food_name }}', {{ menu.price }}, '{{ menu.img.url }}', this)">
                <img src="{% if menu.img %}{{ menu.img.url }}{% endif %}" alt="{{ menu.food_name }}" class="card-img-top">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary">{{ menu.food_name }}</h5>
                    <p class="card-text text-muted">{{ menu.price }}원</p>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="selected-items mt-4">
        <h3 class="text-center">선택한 상품</h3>
        <div id="selectedItemsList"></div>
    </div>
    <div class="total-price mt-3">
        <h3 class="text-center">총 금액: <span id="totalPrice">0원</span></h3>
    </div>
    <div class="actions text-center">
        <button class="btn btn-danger" onclick="clearItems()">전체삭제</button>
        <button class="btn btn-success" id="submitOrderBtn">결제하기</button>
    </div>
</div>

<script>
    window.addEventListener('load', function () {
        const welcomeMessage = "반갑습니다. 원하시는 메뉴를 추천해 드리겠습니다. 필요한 것이 있다면 말씀해주세요.";
        speak(welcomeMessage, startSpeechRecognition);
    });

    const startButton = document.getElementById('startButton');
    const transcription = document.getElementById('transcription');

    function getCsrfToken() {
        const csrfTokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfTokenElement) {
            return csrfTokenElement.value;
        } else {
            console.error('CSRF 토큰을 찾을 수 없습니다.');
            return null;
        }
    }

    function speak(text, callback) {
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.onend = function () {
            console.log("음성 안내가 끝났습니다.");
            if (callback) {
                callback();
            }
        };
        synth.speak(utterance);
    }

    function startSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("음성 인식이 지원되지 않는 브라우저입니다.");
        } else {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.start();
            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                transcription.textContent = transcript;
                const csrfToken = getCsrfToken();
                axios.post('{% url "orders:aibot" %}', {inputText: transcript}, {
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(function (response) {
                    const responseText = response.data.responseText;
                    const hashtags = response.data.hashtags;
                    console.log('서버 응답:', responseText);
                    speak(responseText, function() {
                        updateMenus(hashtags);
                    });
                })
                .catch(function (error) {
                    console.error('에러:', error);
                });
            };
            recognition.onend = function () {
                startButton.textContent = '음성 입력 다시 시작';
            };
        }
    }

    function updateMenus(hashtags) {
        $.ajax({
            url: '/orders/get_menus/',
            data: {hashtags: hashtags},
            dataType: 'json',
            success: function (data) {
                const menus = data.menus;
                const menuContainer = $('#menuContainer');
                menuContainer.empty();
                menus.forEach(menu => {
                    const menuItem = `
                        <div class="menu-item card" onclick="addItem('${menu.food_name}', ${menu.price}, '${menu.img_url}', this)">
                            <img src="${menu.img_url}" alt="${menu.food_name}" class="card-img-top">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary">${menu.food_name}</h5>
                                <p class="card-text text-muted">${menu.price}원</p>
                            </div>
                        </div>
                    `;
                    menuContainer.append(menuItem);
                });
            },
            error: function (error) {
                console.error('메뉴 업데이트 중 오류 발생:', error);
            }
        });
    }

    const selectedItems = {};

    function addItem(name, price, imgUrl, element) {
        if (!selectedItems[name]) {
            selectedItems[name] = {price: price, count: 1, imgUrl: imgUrl};
        } else {
            selectedItems[name].count += 1;
        }
        updateSelectedItemsList();
        flyToCart(element, document.getElementById('selectedItemsList'));
    }

    function updateSelectedItemsList() {
        const selectedItemsList = document.getElementById('selectedItemsList');
        selectedItemsList.innerHTML = '';
        let totalPrice = 0;
        for (const [name, item] of Object.entries(selectedItems)) {
            const itemElement = document.createElement('div');
            itemElement.classList.add('selected-item');
            itemElement.innerHTML = `
                <img src="${item.imgUrl}" alt="${name}">
                <span>${name}</span>
                <span>${item.price}원</span>
                <span>${item.count}개</span>
                <button class="btn btn-danger btn-sm" onclick="removeItem('${name}')">삭제</button>
            `;
            selectedItemsList.appendChild(itemElement);
            totalPrice += item.price * item.count;
        }
        document.getElementById('totalPrice').textContent = `${totalPrice}원`;
    }

    function removeItem(name) {
        if (selectedItems[name]) {
            delete selectedItems[name];
            updateSelectedItemsList();
        }
    }

    function clearItems() {
        for (const key in selectedItems) {
            delete selectedItems[key];
        }
        updateSelectedItemsList();
    }

    function flyToCart(element, targetElement) {
        const imgToDrag = element.querySelector("img");
        if (imgToDrag) {
            const imgClone = imgToDrag.cloneNode(true);
            const rect = imgToDrag.getBoundingClientRect();
            imgClone.style.position = 'absolute';
            imgClone.style.top = rect.top + 'px';
            imgClone.style.left = rect.left + 'px';
            imgClone.style.width = '100px';
            imgClone.style.height = '100px';
            imgClone.classList.add('fly-to-cart');
            document.body.appendChild(imgClone);

            const targetRect = targetElement.getBoundingClientRect();
            setTimeout(() => {
                imgClone.style.transform = `translate(${targetRect.left - rect.left}px, ${targetRect.top - rect.top}px) scale(0.5)`;
            }, 10);

            setTimeout(() => {
                imgClone.remove();
            }, 1000);
        }
    }

    document.getElementById('submitOrderBtn').addEventListener('click', function () {
        const selectedItemsArray = Object.entries(selectedItems).map(([name, item]) => {
            return {name: name, count: item.count};
        });

        const totalPrice = calculateTotalPrice(selectedItems);

        $.ajax({
            url: '/orders/submit_order/',
            cache: false,
            dataType: 'json',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({items: selectedItemsArray, total_price: totalPrice}),
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRFToken', $.cookie('csrftoken'));
            },
            success: function (data) {
                console.log('주문이 성공적으로 처리되었습니다.');
                window.location.href = '/orders/order_complete/' + data.order_number + '/';
            },
            error: function (error) {
                console.error('주문 처리 중 오류가 발생했습니다:', error);
            }
        });
    });

    function calculateTotalPrice(selectedItems) {
        let totalPrice = 0;
        for (const item of Object.values(selectedItems)) {
            totalPrice += item.price * item.count;
        }
        return totalPrice;
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Lining</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ */

        .menu-item,
        .selected-item {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-direction: column;
            transition: transform 0.2s;
        }

        .menu-item img {
            width: 250px;
            height: 250px;
        }

        .menu-item:hover {
            transform: scale(1.05);
        }

        .selected-item span {
            margin: 0 5px;
        }

        .actions button {
            margin: 5px;
        }

        .card-body {
            text-align: center;
        }

        .fly-to-cart {
            position: absolute;
            z-index: 1000;
            transition: transform 1s ease-in-out;
        }

        #selectedItemsList {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .selected-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-direction: row;
            width: 600px;
            margin: 5px 0;
        }

        .selected-item img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Silver Lining</h2>
    <form id="speechForm">
        {% csrf_token %}
    </form>
    <p id="transcription"></p>

    <div class="button d-flex flex-wrap justify-content-center" id="menuContainer">
    </div>

    <div class="selected-items mt-4">
        <h3 class="text-center">ì„ íƒí•œ ìƒí’ˆ ğŸ›’</h3>
        <div id="selectedItemsList"></div>
    </div>
    <div class="total-price mt-3">
        <h3 class="text-center">ì´ ê¸ˆì•¡: <span id="totalPrice">0ì›</span></h3>
    </div>
    <div class="actions text-center">
        <button class="btn btn-danger" onclick="clearItems()">ì „ì²´ì‚­ì œ</button>
        <button class="btn btn-success" id="submitOrderBtn">ê²°ì œí•˜ê¸°</button>
    </div>
</div>

<script>
    window.addEventListener('load', function () {
        const hashtags = "";
        updateMenus(hashtags)
        const welcomeMessage = "ë°˜ê°‘ìŠµë‹ˆë‹¤. ì›í•˜ì‹œëŠ” ë©”ë‰´ë¥¼ ì¶”ì²œí•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤. í•„ìš”í•œ ê²ƒì´ ìˆë‹¤ë©´ ë§ì”€í•´ì£¼ì„¸ìš”.";
        speak(welcomeMessage, startSpeechRecognition);
    });

    const startButton = document.getElementById('startButton');
    const transcription = document.getElementById('transcription');

    function getCsrfToken() {
        const csrfTokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfTokenElement) {
            return csrfTokenElement.value;
        } else {
            console.error('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return null;
        }
    }

    function speak(text, callback) {
        const synth = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.onend = function () {
            console.log("ìŒì„± ì•ˆë‚´ê°€ ëë‚¬ìŠµë‹ˆë‹¤.");
            if (callback) {
                callback();
            }
        };
        synth.speak(utterance);
    }

    function startSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
        } else {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.start();
            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                transcription.textContent = transcript;
                const csrfToken = getCsrfToken();
                axios.post('{% url "orders:aibot" %}', {inputText: transcript}, {
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                    .then(function (response) {
                        const responseText = response.data.responseText;
                        const hashtags = response.data.hashtags;
                        console.log('ì„œë²„ ì‘ë‹µ:', responseText);
                        updateMenus(hashtags); // ë©”ë‰´ ì—…ë°ì´íŠ¸ ë¨¼ì € ì‹¤í–‰
                        speak(responseText, startSpeechRecognition); // ê·¸ ë‹¤ìŒì— ìŒì„± ì•ˆë‚´ ì‹¤í–‰
                    })
                    .catch(function (error) {
                        console.error('ì—ëŸ¬:', error);
                    });
            };
            recognition.onend = function () {
                startButton.textContent = 'ìŒì„± ì…ë ¥ ë‹¤ì‹œ ì‹œì‘';
            };
        }
    }

    function updateMenus(hashtags) {
        $.ajax({
            url: '/orders/get_menus/',
            data: {hashtags: hashtags},
            dataType: 'json',
            success: function (data) {
                const menus = data.menus;
                const menuContainer = $('#menuContainer');
                menuContainer.empty();
                menus.forEach(menu => {
                    const menuItem = `
                        <div class="menu-item card" onclick="addItem('${menu.food_name}', ${menu.price}, '${menu.img_url}', this)">
                            <img src="${menu.img_url}" alt="${menu.food_name}" class="card-img-top">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary">${menu.food_name}</h5>
                                <p class="card-text text-muted">${menu.price}ì›</p>
                            </div>
                        </div>
                    `;
                    menuContainer.append(menuItem);
                });
            },
            error: function (error) {
                console.error('ë©”ë‰´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        });
    }

    const selectedItems = {};

    function addItem(name, price, imgUrl, element) {
        if (!selectedItems[name]) {
            selectedItems[name] = {price: price, count: 1, imgUrl: imgUrl};
        } else {
            selectedItems[name].count += 1;
        }
        updateSelectedItemsList();
        flyToCart(element, document.getElementById('selectedItemsList'));
    }

    function updateSelectedItemsList() {
        const selectedItemsList = document.getElementById('selectedItemsList');
        selectedItemsList.innerHTML = '';
        let totalPrice = 0;
        for (const [name, item] of Object.entries(selectedItems)) {
            const itemElement = document.createElement('div');
            itemElement.classList.add('selected-item');
            itemElement.innerHTML = `
                <img src="${item.imgUrl}" alt="${name}">
                <span>${name}</span>
                <span>${item.price}ì›</span>
                <span>${item.count}ê°œ</span>
                <button class="btn btn-danger btn-sm" onclick="removeItem('${name}')">ì‚­ì œ</button>
            `;
            selectedItemsList.appendChild(itemElement);
            totalPrice += item.price * item.count;
        }
        document.getElementById('totalPrice').textContent = `${totalPrice}ì›`;
    }

    function removeItem(name) {
        if (selectedItems[name]) {
            delete selectedItems[name];
            updateSelectedItemsList();
        }
    }

    function clearItems() {
        for (const key in selectedItems) {
            delete selectedItems[key];
        }
        updateSelectedItemsList();
    }

    function flyToCart(element, targetElement) {
    const imgToDrag = element.querySelector("img");
    if (imgToDrag) {
        const imgClone = imgToDrag.cloneNode(true);
        let rect = imgToDrag.getBoundingClientRect();
        imgClone.style.position = 'absolute';
        imgClone.style.top = rect.top + 'px';
        imgClone.style.left = rect.left + 'px';
        imgClone.style.width = '250px'; // ì´ˆê¸° ì´ë¯¸ì§€ í¬ê¸°
        imgClone.style.height = '250px'; // ì´ˆê¸° ì´ë¯¸ì§€ í¬ê¸°
        imgClone.classList.add('fly-to-cart');
        document.body.appendChild(imgClone);

        // ğŸ›’ ì•„ì´ì½˜ ìœ„ì¹˜ ì„¤ì •
        const cartIconRect = targetElement.getBoundingClientRect();

        // ì¹´íŠ¸ ì•„ì´ì½˜ ì¤‘ì•™ ìœ„ì¹˜ ê³„ì‚°
        const cartCenterX = cartIconRect.left + cartIconRect.width / 2;
        const cartCenterY = cartIconRect.top + cartIconRect.height / 2;

        // ì´ë¯¸ì§€ ì´ë™ ì†ë„ ê³„ì‚°
        const dx = (cartCenterX - rect.left) / 120; // x ë°©í–¥ ì´ë™ ì†ë„
        const dy = (cartCenterY - rect.top) / 120; // y ë°©í–¥ ì´ë™ ì†ë„

        // ì´ë¯¸ì§€ í¬ê¸° ê°ì†Œ ì†ë„ ê³„ì‚°
        const dw = (250 - 100) / 120; // ì´ë¯¸ì§€ í¬ê¸° ê°ì†Œ ì†ë„

        // ì´ë¯¸ì§€ ì´ë™ ë° í¬ê¸° ì¡°ì ˆ í•¨ìˆ˜
        function moveImage() {
            rect = imgClone.getBoundingClientRect();
            if ((dx > 0 && rect.left < cartCenterX) || (dx < 0 && rect.left > cartCenterX) ||
                (dy > 0 && rect.top < cartCenterY) || (dy < 0 && rect.top > cartCenterY)) {
                imgClone.style.left = (rect.left + dx) + 'px';
                imgClone.style.top = (rect.top + dy) + 'px';

                // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆ
                const newWidth = parseFloat(imgClone.style.width) - dw;
                imgClone.style.width = newWidth + 'px';
                imgClone.style.height = newWidth + 'px';

                requestAnimationFrame(moveImage);
            } else {
                imgClone.remove();
            }
        }

        // ì´ë¯¸ì§€ ì´ë™ ì‹œì‘
        moveImage();
    }
}



    document.getElementById('submitOrderBtn').addEventListener('click', function () {
        const selectedItemsArray = Object.entries(selectedItems).map(([name, item]) => {
            return {name: name, count: item.count};
        });

        const totalPrice = calculateTotalPrice(selectedItems);

        $.ajax({
            url: '/orders/submit_order/',
            cache: false,
            dataType: 'json',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({items: selectedItemsArray, total_price: totalPrice}),
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRFToken', $.cookie('csrftoken'));
            },
            success: function (data) {
                console.log('ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/orders/order_complete/' + data.order_number + '/';
            },
            error: function (error) {
                console.error('ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
            }
        });
    });

    function calculateTotalPrice(selectedItems) {
        let totalPrice = 0;
        for (const item of Object.values(selectedItems)) {
            totalPrice += item.price * item.count;
        }
        return totalPrice;
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
